name: Update geosite-reject rule-set (Mullvad Ads)

on:
  schedule:
    - cron: "0 3 * * 1"   # 每周一 UTC 03:00
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          mkdir -p rule-set
          mkdir -p tmp

      - name: Download Mullvad ad domain list
        run: |
          curl -fsSL \
            https://raw.githubusercontent.com/mullvad/dns-blocklists/main/output/doh/doh_adblock.txt \
            -o tmp/raw.txt

      - name: Clean domains (remove wildcard, dedupe, sort)
        run: |
          sed 's/^\*\.\?//' tmp/raw.txt \
            | sed 's/^\.\+//' \
            | sed '/^\s*$/d' \
            | sort -u \
            > tmp/domains.txt

      - name: Generate geosite-reject.json (jq)
        run: |
          jq -n \
            --rawfile domains tmp/domains.txt \
            '{
              version: 3,
              rules: [
                {
                  domain_suffix: ($domains | split("\n") | map(select(length > 0)))
                }
              ]
            }' > rule-set/geosite-reject.json

      - name: Install sing-box
        run: |
          curl -fsSL https://sing-box.app/install.sh | sh

      - name: Compile sing-box rule-set
        run: |
          sing-box rule-set compile \
            --output rule-set/geosite-reject.srs \
            rule-set/geosite-reject.json

      - name: Commit & Push rule-set
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

          git add rule-set/geosite-reject.json rule-set/geosite-reject.srs
          git commit -m "Auto update geosite-reject rule-set" || echo "No changes"
          git push
